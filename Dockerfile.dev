# Development Dockerfile for User Service
FROM node:20-slim

# Set the working directory
WORKDIR /app

# Install curl for health checks and other required tools
RUN apt-get update && apt-get install -y \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install grpc_health_probe for gRPC health checks
RUN GRPC_HEALTH_PROBE_VERSION=v0.4.25 && \
    curl -fsSL --insecure https://github.com/grpc-ecosystem/grpc-health-probe/releases/download/${GRPC_HEALTH_PROBE_VERSION}/grpc_health_probe-linux-amd64 \
    -o /bin/grpc_health_probe && \
    chmod +x /bin/grpc_health_probe

# Install Bun
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:$PATH"

# Create necessary directories
RUN mkdir -p src

# Copy package files first for better caching
COPY package.docker.json ./package.json

# Install dependencies using npm (more reliable in Docker)
RUN npm install

# Copy necessary configuration files
COPY tsconfig*.json ./
COPY nest-cli.json ./
COPY .prettierrc* ./
COPY eslint.config.mjs ./

# Set environment variables for development
ENV NODE_ENV=development
ENV PORT=50051

# Expose the application port
EXPOSE 50051

# Use npm for development start (more reliable)
CMD ["npm", "run", "start:dev"]